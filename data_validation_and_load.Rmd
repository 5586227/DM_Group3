---
title: "Data Validation"
output: html_document
date: "2024-03-14"
editor_options: 
  chunk_output_type: console
---

```{r}
library(dplyr)
library(tidyr)

```

#read files
```{r}
customer <- readr::read_csv("data_upload/CUSTOMER.csv")
address <- readr::read_csv("data_upload/ADDRESS.csv")
category <- readr::read_csv("data_upload/CATEGORY.csv")
supplier <- readr::read_csv("data_upload/SUPPLIER.csv")
discount <- readr::read_csv("data_upload/DISCOUNT.csv")
product <- readr::read_csv("data_upload/PRODUCT.csv")
order_item <- readr::read_csv("data_upload/ORDER_ITEM.csv")
order_detail <- readr::read_csv("data_upload/ORDER_DETAIL.csv")
advertisement <- readr::read_csv("data_upload/ADVERTISEMENT.csv")
advertise_in <- readr::read_csv("data_upload/ADVERTISE_IN.csv")

```

```{r}
# List of tables and their corresponding primary key columns
table_pk <- list(
  customer = "customer_id",
  address = "postcode",
  category = "category_id",
  supplier = "supplier_id",
  product = "product_id",
  discount = "promo_code",
  order_detail = "order_id",
  order_item = c("order_id", "product_id"),
  advertisement = "ad_id",
  advertise_in = c("ad_id", "product_id")
)

# Loop through each table and check for duplicates
for (table_name in names(table_pk)) {
  table <- get(table_name)
  key_columns <- table_pk[[table_name]]
  duplicates <- table[duplicated(table[, key_columns]), key_columns]
  if (nrow(duplicates) > 0) {
    print(paste("Duplicate key in", table_name, ":"))
    print(duplicates)
  } else {
    print(paste("No duplicate key in", table_name))
  }
}

```

#CUSTOMER
```{r}
#Check format of first and last name (1st alphabet is uppercase, rest is lowercase)
invalid_customer_firstname <- customer[!grepl("^[A-Z][a-z]*$", customer$first_name), c("customer_id", "first_name")]
invalid_customer_lastname <- customer[!grepl("^[A-Z][a-z]*$", customer$last_name), c("customer_id", "last_name")]

#Check email format
invalid_customer_email <- customer[!grepl("^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$", customer$customer_email), c("customer_id", "customer_email")]

#Check format of mobile number (+xx xxx xxx xxxx)
invalid_customer_mobile <- customer[!grepl("^\\+\\d{1,3}\\s[0-9]{3}\\s[0-9]{3}\\s[0-9]{4}$", customer$customer_mobile), c("customer_id", "customer_mobile")]

#Check for missing data
na_customer_customer_id <- customer[is.na(customer$customer_id), "customer_id"]
na_customer_first_name <- customer[is.na(customer$first_name), c("customer_id", "first_name")]
na_customer_last_name <- customer[is.na(customer$last_name), c("customer_id", "last_name")]
na_customer_customer_email <- customer[is.na(customer$customer_email), c("customer_id", "customer_email")]
na_customer_customer_mobile <- customer[is.na(customer$customer_mobile), c("customer_id", "customer_mobile")]

#Remove unclean data
bad_customer_record <- unique(c(invalid_customer_firstname$customer_id, 
                                invalid_customer_lastname$customer_id, 
                                invalid_customer_email$customer_id, 
                                invalid_customer_mobile$customer_id,
                                na_customer_customer_id$customer_id,
                                na_customer_first_name$customer_id,
                                na_customer_last_name$customer_id,
                                na_customer_customer_email$customer_id,
                                na_customer_customer_mobile$customer_id))
customer <- customer[!(customer$customer_id %in% bad_customer_record), ]

```

#ADDRESS
```{r}
#Check for missing data
na_address_postcode <- address[is.na(address$postcode), "postcode"]
na_address_street <- address[is.na(address$street), c("postcode", "street")]
na_address_city <- address[is.na(address$city), c("postcode", "city")]
na_address_country <- address[is.na(address$country), c("postcode", "country")]

#Check if customer_id exists in the CUSTOMER table
invalid_customer_fk <- address[!address$customer_id %in% customer$customer_id, c("postcode", "customer_id")]

#Remove unclean data
bad_address_record <- unique(c(na_address_postcode$postcode,
                               na_address_street$postcode,
                               na_address_city$postcode,
                               na_address_country$postcode,
                               invalid_customer_fk$postcode))
address <- address[!(address$postcode %in% bad_address_record), ]


```

# CATEGORY
```{r}
#Check category (can contain alphabets)
invalid_category_name <- category[!grepl("^[A-Za-z]+( [A-Za-z]+)*$", category$category_name), c("category_id", "category_name")]

#Check for duplicate category name
duplicate_category_name <- category[duplicated(category$category_name), c("category_id", "category_name")]

#Check for negative prices
negative_category_fee <- category[category$category_fee < 0, c("category_id", "category_fee")]

#Check for missing data
na_category_category_id <- category[is.na(category$category_id), "category_id"]
na_category_category_name <- category[is.na(category$category_name), c("category_id", "category_name")]
na_category_category_fee <- category[is.na(category$category_fee), c("category_id", "category_fee")]

#Remove unclean data
bad_category_record <- unique(c(invalid_category_name$category_id,
                                duplicate_category_name$category_id,
                                negative_category_fee$category_id,
                                na_category_category_id$category_id,
                                na_category_category_name$category_id,
                                na_category_category_fee$category_id))
category <- category[!(category$category_id %in% bad_category_record), ]

```

#SUPPLIER
```{r}
#Check supplier (can contain alphabets, comma, hyphen, dot)
invalid_supplier_name <- supplier[!grepl("^[A-Za-z,.-]+( [A-Za-z,.-]+)*$", supplier$supplier_name), c("supplier_id", "supplier_name")]

#Check email format
invalid_supplier_email <- supplier[!grepl("^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$", supplier$supplier_email), c("supplier_id", "supplier_email")]

#Check format of mobile number (+xx xxx xxx xxxx)
invalid_supplier_mobile <- supplier[!grepl("^^\\+\\d{1,3}\\s[0-9]{3}\\s[0-9]{3}\\s[0-9]{4}$", supplier$supplier_mobile), c("supplier_id", "supplier_mobile")]

#Check for missing data
na_supplier_supplier_id <- supplier[is.na(supplier$supplier_id), "supplier_id"]
na_supplier_supplier_name <- supplier[is.na(supplier$supplier_name), c("supplier_id", "supplier_name")]
na_supplier_supplier_email <- supplier[is.na(supplier$supplier_email), c("supplier_id", "supplier_email")]
na_supplier_supplier_mobile <- supplier[is.na(supplier$supplier_mobile), c("supplier_id", "supplier_mobile")]

#Remove unclean data
bad_supplier_record <- unique(c(invalid_supplier_name$supplier_id, 
                                invalid_supplier_email$supplier_id,
                                invalid_supplier_mobile$supplier_id,
                                na_supplier_supplier_id$supplier_id, 
                                na_supplier_supplier_name$supplier_id,
                                na_supplier_supplier_email$supplier_id,
                                na_supplier_supplier_mobile$supplier_id))
supplier <- supplier[!(supplier$supplier_id %in% bad_supplier_record), ]

```

# DISCOUNT
```{r}
#Check percent
invalid_discount_percent <- discount[!grepl("^[0-9]+$", discount$discount_percent), c("promo_code", "discount_percent")]

#Check for missing data
na_discount_promo_code <- discount[is.na(discount$promo_code), "promo_code"]
na_discount_discount_percent <- discount[is.na(discount$discount_percent), c("promo_code", "discount_percent")]

#Remove unclean data
bad_discount_record <- unique(c(invalid_discount_percent$promo_code,
                                na_discount_promo_code$promo_code,
                                na_discount_discount_percent$promo_code))
discount <- discount[!(discount$promo_code %in% bad_discount_record), ]

```

# PRODUCT
```{r}
#Check product name (can contain alphabets, comma, hyphen, dot)
invalid_product_name <- product[!grepl("^[A-Za-z,.-]+( [A-Za-z,.-]+)*$", product$product_name), c("product_id", "product_name")]

#Check for negative prices
negative_unit_prices <- product[product$unit_price < 0, c("product_id", "unit_price")]

#Check invalid stock
invalid_stock <- product[!grepl("^[0-9]+$", product$stock_on_hand), c("product_id", "stock_on_hand")]
negative_stock <- product[product$stock_on_hand < 0, c("product_id", "stock_on_hand")]

#Check if supplier_id exists in the SUPPLIER table
invalid_supplier_fk <- product[!product$supplier_id %in% supplier$supplier_id, c("product_id", "supplier_id")]

#Check if category_id exists in the CATEGORY table
invalid_category_fk <- product[!product$category_id %in% category$category_id, c("product_id", "category_id")]

#Check if main product is self referential and it cannot be the same as product_id
invalid_main_product_ids <- product[!is.na(product$main_product_id) & 
                                      !(product$main_product_id %in% product$product_id & 
                                          product$main_product_id != product$product_id), c("product_id", "main_product_id")]

#Check for missing data
na_product_product_id <- product[is.na(product$product_id), "product_id"]
na_product_category_id <- product[is.na(product$category_id), c("product_id", "category_id")]
na_product_supplier_id <- product[is.na(product$supplier_id), c("product_id", "supplier_id")]
na_product_product_name <- product[is.na(product$product_name), c("product_id", "product_name")]
na_product_unit_price <- product[is.na(product$unit_price), c("product_id", "unit_price")]
na_product_stock_on_hand <- product[is.na(product$stock_on_hand), c("product_id", "stock_on_hand")]

#Remove unclean data
bad_product_record <- unique(c(invalid_product_name$product_id, 
                               negative_unit_prices$product_id,
                               invalid_stock$product_id,
                               negative_stock$product_id,
                               invalid_supplier_fk$product_id,
                               invalid_category_fk$product_id,
                               invalid_main_product_ids$product_id,
                               na_product_product_id$product_id,
                               na_product_category_id$product_id,
                               na_product_supplier_id$product_id,
                               na_product_product_name$product_id,
                               na_product_unit_price$product_id,
                               na_product_stock_on_hand$product_id))
product <- product[!(product$product_id %in% bad_product_record), ]

```

# ORDER_DETAIL
```{r}
#Check if customer_id exists in the CUSTOMER table
invalid_customer_fk <- order_detail[!order_detail$customer_id %in% customer$customer_id, "order_id"]

#Check if promo_code exists in the DISCOUNT table
discounted_order <- order_detail[!is.na(order_detail$promo_code), ]
invalid_promo_fk <- discounted_order[!discounted_order$promo_code %in% discount$promo_code, c("order_id", "promo_code")]

#Check order status
status <- c("Pending", "Paid", "Shipped", "Completed", "Cancelled")
invalid_order_status <- order_detail[!order_detail$order_status %in% status, c("order_id", "order_status")]

#Check payment method
payment <- c("Mastercard", "Card", "Amex")
invalid_payment_method <- order_detail[!order_detail$payment_method %in% payment, c("order_id", "payment_method")]

#Check date format (dd/mm/yyyy)
invalid_order_date <- order_detail[!grepl("^\\d{2}/\\d{2}/\\d{4}$", order_detail$order_date), c("order_id", "order_date")]

#Check for negative delivery fee
negative_delivery_fee <- order_detail[order_detail$delivery_fee < 0, c("order_id", "delivery_fee")]

#Check for missing data
na_order_order_id <- order_detail[is.na(order_detail$order_id), "order_id"]
na_order_customer_id <- order_detail[is.na(order_detail$customer_id), c("order_id", "customer_id")]
na_order_order_status <- order_detail[is.na(order_detail$order_status), c("order_id", "order_status")]
na_order_order_date <- order_detail[is.na(order_detail$order_date), c("order_id", "order_date")]
na_order_payment_method <- order_detail[is.na(order_detail$payment_method), c("order_id", "payment_method")]
na_order_delivery_fee <- order_detail[is.na(order_detail$delivery_fee), c("order_id", "delivery_fee")]

#Remove unclean data
bad_order_record <- unique(c(invalid_customer_fk$order_id,
                             invalid_promo_fk$order_id,
                             invalid_order_status$order_id,
                             invalid_payment_method$order_id,
                             invalid_order_date$order_id,
                             negative_delivery_fee$order_id,
                             na_order_order_id$order_id,
                             na_order_customer_id$order_id,
                             na_order_order_status$order_id,
                             na_order_order_date$order_id,
                             na_order_payment_method$order_id,
                             na_order_delivery_fee$order_id))
order_detail <- order_detail[!(order_detail$order_id %in% bad_order_record), ]

```

# ORDER_ITEM
```{r}
#Check if order_id exists in the ORDER_ITEM table
invalid_order_fk <- order_item[!order_item$order_id %in% order_detail$order_id, "order_id"]

#Check if product_id exists in the PRODUCT table
invalid_product_fk <- order_item[!order_item$product_id %in% product$product_id, c("order_id", "product_id")]

#Check invalid order quantity
invalid_quantity <- order_item[!grepl("^[0-9]+$", order_item$order_quantity), c("order_id", "order_quantity")]
negative_zero_quantity <- order_item[order_item$order_quantity < 1, c("order_id", "order_quantity")]

#Check for missing data
na_order_item_order_id <- order_item[is.na(order_item$order_id), "order_id"]
na_order_item_product_id <- order_item[is.na(order_item$product_id), c("order_id", "product_id")]
na_order_item_order_quantity <- order_item[is.na(order_item$order_quantity), c("order_id", "order_quantity")]

#Remove unclean data
bad_order_item_record <- unique(c(invalid_order_fk$order_id,
                                  invalid_product_fk$order_id,
                                  invalid_quantity$order_id,
                                  negative_zero_quantity$order_id,
                                  na_order_item_order_id$order_id,
                                  na_order_item_product_id$order_id,
                                  na_order_item_order_quantity$order_id))
order_item <- order_item[!(order_item$order_id %in% bad_order_item_record), ]

```

# ADVERTISEMENT
```{r}
#Check ad frequency (can only contain integer)
invalid_ad_frequency <- advertisement[!grepl("^[0-9]+$", advertisement$ad_frequency), c("ad_id", "ad_frequency")]

#Check for negative ad frequency
negative_ad_frequency <- advertisement[advertisement$ad_frequency < 0, c("ad_id", "ad_frequency")]

#Check for negative prices
negative_ad_prices <- advertisement[advertisement$ad_price < 0, c("ad_id", "ad_price")]

#Check for missing data
na_advertisement_ad_id <- advertisement[is.na(advertisement$ad_id), "ad_id"]
na_advertisement_ad_frequency <- advertisement[is.na(advertisement$ad_frequency), c("ad_id", "ad_frequency")]
na_advertisement_ad_price <- advertisement[is.na(advertisement$ad_price), c("ad_id", "ad_price")]
na_advertisement_ad_place <- advertisement[is.na(advertisement$ad_place), c("ad_id", "ad_place")]

#Remove unclean data
bad_advertisement_record <- unique(c(invalid_ad_frequency$ad_id,
                                     negative_ad_frequency$ad_id,
                                     negative_ad_prices$ad_id,
                                     na_advertisement_ad_id$ad_id,
                                     na_advertisement_ad_frequency$ad_id,
                                     na_advertisement_ad_price$ad_id,
                                     na_advertisement_ad_place$ad_id))
advertisement <- advertisement[!(advertisement$ad_id %in% bad_advertisement_record), ]

```

#ADVERTISE_IN
```{r}
#Check if ad_id exists in the ADVERTISEMENT table
invalid_advertisement_fk <- advertise_in[!advertise_in$ad_id %in% advertisement$ad_id, "ad_id"]

#Check if product_id exists in the PRODUCT table
invalid_product_fk <- advertise_in[!advertise_in$product_id %in% product$product_id, c("ad_id", "product_id")]

#Check for missing data
na_advertise_in_ad_id <- advertise_in[is.na(advertise_in$ad_id), "ad_id"]
na_advertise_in_product_id <- advertise_in[is.na(advertise_in$product_id), c("ad_id", "product_id")]

#Remove unclean data
bad_advertise_in_record <- unique(c(invalid_advertisement_fk$ad_id,
                                    invalid_product_fk$ad_id,
                                    na_advertise_in_ad_id$ad_id,
                                    na_advertise_in_product_id$ad_id))
advertise_in <- advertise_in[!(advertise_in$ad_id %in% bad_advertise_in_record), ]

```


```{r}
#add new records into table
connect <- dbConnect(RSQLite::SQLite(), "database.db")

tables <- c("CUSTOMER", "ADDRESS", "CATEGORY", "SUPPLIER", "PRODUCT", "DISCOUNT", 
            "ORDER_ITEM", "ORDER_DETAIL", "ADVERTISEMENT", "ADVERTISE_IN")

for (table in tables) {
  existing <- dbGetQuery(connect, paste("SELECT * FROM", table))
  new <- anti_join(get(table), existing)
  dbWriteTable(connect, table, new, append=TRUE)
}

dbDisconnect(connect)
